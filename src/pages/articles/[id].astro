---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import TagList from "../../components/TagList.astro";
import { addPublishDateToArticles } from "../../lib/article.ts";
import { SITE_CONFIG } from "../../config/site";
import { extractDescriptionFromMarkdown } from "../../lib/seo";

export async function getStaticPaths() {
  const articles = await getCollection("articles", ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });
  const articlesWithDate = addPublishDateToArticles(articles);
  return articlesWithDate.map((article) => ({
    params: { id: article.id },
    props: article,
  }));
}

const article = Astro.props;
const { Content } = await render(article);

const description =
  article.data.description ||
  extractDescriptionFromMarkdown(article.body || "");
const image = article.data.thumbnail || SITE_CONFIG.defaultImage;
---

<Layout
  title={`${article.data.title} | ${SITE_CONFIG.siteName}`}
  description={description}
  image={image}
  isArticle={true}
>
  <article class="container-main">
    <Breadcrumb
      items={[
        { label: "ホーム", href: "/" },
        { label: article.data.title, href: `/articles/${article.id}` },
      ]}
    />
    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-3 text-gray-900">
        {article.data.title}
      </h1>
      <time
        datetime={article.publishDate.toISOString()}
        class="block text-sm text-gray-500 mb-4"
      >
        {
          article.publishDate.toLocaleDateString("ja-JP", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        }
      </time>
      {
        article.data.tags && article.data.tags.length > 0 && (
          <TagList tags={article.data.tags} />
        )
      }
    </header>
    <div class="prose prose-slate max-w-none">
      <Content />
    </div>
  </article>
</Layout>
