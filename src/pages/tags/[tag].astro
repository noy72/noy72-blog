---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { addPublishDateToArticles } from "../../lib/article.ts";

export async function getStaticPaths() {
  const articles = await getCollection("articles", ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });

  const articlesByTag: Record<string, typeof articles> = {};
  for (const article of articles) {
    for (const tag of article.data.tags || []) {
      if (!articlesByTag[tag]) articlesByTag[tag] = [];
      articlesByTag[tag].push(article);
    }
  }

  return Object.entries(articlesByTag).map(([tag, taggedArticles]) => {
    const articlesWithDate = addPublishDateToArticles(taggedArticles).toSorted(
      (a, b) => b.publishDate.getTime() - a.publishDate.getTime(),
    );
    return {
      params: { tag },
      props: { articles: articlesWithDate },
    };
  });
}

const { tag } = Astro.params;
const { articles } = Astro.props;
---

<Layout>
  <main class="max-w-screen-md mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-12 text-gray-900">タグ: {tag}</h1>
    <div class="flex flex-col gap-12">
      {
        articles.map((article) => (
          <article class="relative">
            <h2 class="mb-2 text-xl font-semibold">
              <a
                href={`/articles/${article.id}`}
                class="text-gray-900 hover:text-blue-500 transition-colors"
              >
                {article.data.title}
              </a>
            </h2>
            <time
              datetime={article.publishDate.toISOString()}
              class="block text-sm text-gray-500 mb-3"
            >
              {article.publishDate.toLocaleDateString("ja-JP", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })}
            </time>
            {article.data.description && (
              <p class="text-gray-600 leading-relaxed mb-0">
                {article.data.description}
              </p>
            )}
            {article.data.tags && article.data.tags.length > 0 && (
              <ul class="flex gap-2 flex-wrap mt-3 list-none p-0">
                {article.data.tags.map((articleTag) => (
                  <li class="text-sm">
                    <a
                      href={`/tags/${articleTag}`}
                      class="text-gray-500 hover:text-blue-500 transition-colors"
                    >
                      #{articleTag}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </article>
        ))
      }
    </div>
  </main>
</Layout>
