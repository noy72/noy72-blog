---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import ArticleCard from "../../components/ArticleCard.astro";
import { addPublishDateToArticles } from "../../lib/article.ts";

export async function getStaticPaths() {
  const articles = await getCollection("articles", ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });

  const articlesByTag: Record<string, typeof articles> = {};
  for (const article of articles) {
    for (const tag of article.data.tags || []) {
      if (!articlesByTag[tag]) articlesByTag[tag] = [];
      articlesByTag[tag].push(article);
    }
  }

  return Object.entries(articlesByTag).map(([tag, taggedArticles]) => {
    const articlesWithDate = addPublishDateToArticles(taggedArticles).toSorted(
      (a, b) => b.publishDate.getTime() - a.publishDate.getTime(),
    );
    return {
      params: { tag },
      props: { articles: articlesWithDate },
    };
  });
}

const { tag } = Astro.params;
const { articles } = Astro.props;
---

<Layout
  title={`タグ: ${tag}`}
  description={`"${tag}" タグの記事一覧`}
  noIndex={true}
>
  <main class="container-main">
    <Breadcrumb
      items={[
        { label: "ホーム", href: "/" },
        { label: "タグ一覧", href: "/tags" },
        { label: tag, href: `/tags/${tag}` },
      ]}
    />
    <h1 class="text-3xl font-semibold mb-12 text-gray-900">タグ: {tag}</h1>
    <div class="flex flex-col gap-12">
      {
        articles.map((article) => (
          <ArticleCard
            id={article.id}
            title={article.data.title}
            publishDate={article.publishDate}
            description={article.data.description}
            tags={article.data.tags}
            thumbnail={article.data.thumbnail}
          />
        ))
      }
    </div>
  </main>
</Layout>
