---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { addPublishDateToArticles } from "../../lib/article.ts";

export async function getStaticPaths() {
  const articles = await getCollection("articles", ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });

  const articlesByTag: Record<string, typeof articles> = {};
  for (const article of articles) {
    for (const tag of article.data.tags || []) {
      if (!articlesByTag[tag]) articlesByTag[tag] = [];
      articlesByTag[tag].push(article);
    }
  }

  return Object.entries(articlesByTag).map(([tag, taggedArticles]) => {
    const articlesWithDate = addPublishDateToArticles(taggedArticles).toSorted(
      (a, b) => b.publishDate.getTime() - a.publishDate.getTime(),
    );
    return {
      params: { tag },
      props: { articles: articlesWithDate },
    };
  });
}

const { tag } = Astro.params;
const { articles } = Astro.props;
---

<Layout>
  <main class="container-main">
    <h1 class="page-title">タグ: {tag}</h1>
    <div class="article-list">
      {
        articles.map((article) => (
          <article class="relative">
            <h2 class="article-title">
              <a href={`/articles/${article.id}`} class="link-primary">
                {article.data.title}
              </a>
            </h2>
            <time
              datetime={article.publishDate.toISOString()}
              class="meta-date"
            >
              {article.publishDate.toLocaleDateString("ja-JP", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })}
            </time>
            {article.data.description && (
              <p class="article-description">{article.data.description}</p>
            )}
            {article.data.tags && article.data.tags.length > 0 && (
              <ul class="tag-list mt-3">
                {article.data.tags.map((articleTag) => (
                  <li class="tag-list-item">
                    <a href={`/tags/${articleTag}`} class="link-tag">
                      #{articleTag}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </article>
        ))
      }
    </div>
  </main>
</Layout>
